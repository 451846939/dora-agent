<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>SSE è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: sans-serif; padding: 2em; background: #f6f8fa; }
        #log { display: flex; flex-direction: column; gap: 1em; }
        .card {
            background: #fff;
            border-left: 6px solid gray;
            padding: 1em;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            white-space: normal;
        }
        .started { border-color: #0a84ff; }
        .completed { border-color: #28a745; }
        .failed { border-color: #d73a49; }
        .finished { border-color: #6f42c1; }

        details { margin-top: 0.5em; }
        pre {
            background: #f1f1f1;
            padding: 0.5em;
            overflow-x: auto;
        }
        code { background: #eee; padding: 0 0.3em; border-radius: 4px; }
    </style>
</head>
<body>
<h1>SSE å·¥ä½œæµå±•ç¤ºå™¨</h1>
<label>æŸ¥è¯¢å‚æ•°ï¼ˆquery=ï¼‰ï¼š<input type="text" id="query" value="è¯¦ç»†å†™ä¸€ç¯‡ç¼…ç”¸å‘ç”Ÿ7.9çº§åœ°éœ‡çš„æ–°é—»"></label>
<button onclick="connect()">è¿æ¥ SSE</button>

<h2>æ¥æ”¶åˆ°çš„äº‹ä»¶ï¼š</h2>
<div id="log"></div>

<script>
    let eventSource;

    function connect() {
        const query = document.getElementById("query").value;
        const url = `http://127.0.0.1:3000/sse?query=${encodeURIComponent(query)}`;
        if (eventSource) eventSource.close();

        addCard("ğŸ”Œ å·²è¿æ¥åˆ°: " + url, "started");
        eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
            if (event.data === "[DONE]") {
                addCard("æœåŠ¡ç«¯ä¸»åŠ¨ç»“æŸè¿æ¥", "finished");
                eventSource.close();
            } else {
                try {
                    const log = JSON.parse(event.data);
                    renderLogCard(log);
                } catch (e) {
                    addCard("âŒ æ— æ³•è§£ææ•°æ®: " + event.data, "failed");
                }
            }
        };

        eventSource.onerror = () => {
            addCard("âŒ è¿æ¥é”™è¯¯ï¼Œå·²æ–­å¼€", "failed");
            eventSource.close();
        };
    }

    function renderLogCard(log) {
        const div = document.createElement("div");
        div.className = `card ${log.status}`;

        div.innerHTML = `
            <b>[${log.status.toUpperCase()}]</b> Step ${log.step_index + 1}/${log.total_steps}<br/>
            ğŸ§± èŠ‚ç‚¹: <code>${log.node_id}</code><br/>
            ğŸ§© Workflow ID: <code>${log.workflow_id}</code><br/>
            ğŸ“ ${log.message}<br/>
            <details>
                <summary>æŸ¥çœ‹è¾“å…¥ / è¾“å‡º</summary>
                <pre><b>è¾“å…¥ï¼š</b>\n${JSON.stringify(log.input, null, 2)}</pre>
                <pre><b>è¾“å‡ºï¼š</b>\n${JSON.stringify(log.output, null, 2)}</pre>
            </details>
        `;

        document.getElementById("log").appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });
    }

    function addCard(message, status = "") {
        const div = document.createElement("div");
        div.className = `card ${status}`;
        div.textContent = message;
        document.getElementById("log").appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });
    }
</script>
</body>
</html>